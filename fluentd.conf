<source>
  @type tail
  path C:/Program Files/pGina/log/pGina.Service.ServiceHost_log.txt
  pos_file C:/authnull-agent/fluentd/ldap.pos
  tag windows-agent.log
  <parse>
    @type none
  </parse>
</source>

<label @PARTIAL>
  <match **>
    @type http
    endpoint https://prod.api.authnull.com/api/v1/log/endpoint/logit
    http_method post
    serializer json
    <buffer>
      @type file
      path /var/log/fluentd/buffer
      flush_mode immediate
    </buffer>
  </match>
</label>

<filter windows-agent.log>
  @type grep
  <regexp>
    key message
    pattern /LdapPlugin: Found established TCP connection on port 3389 from IP:|LdapPlugin: Received username:|LdapPlugin: Authnull Authz Service CallAuthnull Method 1:|LdapPlugin: Authnull Service CallAuthnull Method 1:/
  </regexp>
</filter>

<filter windows-agent.log>
  @type concat
  key message
  n_lines 4
  flush_interval 180s
  timeout_label @PARTIAL  # Label to handle partial logs
</filter>

<filter windows-agent.log>
  @type record_transformer
  enable_ruby true
  <record>
    orgId 84
    tenantId 7
    component "ldap-logs"
  </record>
</filter>

<match windows-agent.log>
  @type http
  endpoint https://prod.api.authnull.com/api/v1/log/endpoint/logit
  http_method post
  serializer json
  <buffer>
    @type file
    path /var/log/fluentd/buffer
    flush_mode immediate
  </buffer>
</match>
